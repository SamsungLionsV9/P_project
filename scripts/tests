"""ëª¨ë“  ì°¨ì¢…ë³„ ì‹¤ì œê°’ vs ì˜ˆì¸¡ê°’ ë¹„êµ í…ŒìŠ¤íŠ¸"""
import pandas as pd
import numpy as np
import joblib

print("="*80)
print("ğŸš— êµ­ì‚°ì°¨ ëª¨ë¸ë³„ ì‹¤ì œê°’ vs ì˜ˆì¸¡ê°’ ë¹„êµ")
print("="*80)

# ë°ì´í„° ë° ëª¨ë¸ ë¡œë“œ
df_raw = pd.read_csv('encar_raw_domestic.csv')
df_detail = pd.read_csv('data/complete_domestic_details.csv')
df = df_raw.merge(df_detail, left_on='Id', right_on='car_id', how='inner')

# ì œë„¤ì‹œìŠ¤ ì œì™¸
genesis_keywords = ['ì œë„¤ì‹œìŠ¤', 'GENESIS', 'Genesis']
genesis_mask = df['Manufacturer'].str.contains('|'.join(genesis_keywords), case=False, na=False)
df = df[~genesis_mask]

# ì „ì²˜ë¦¬
df = df.dropna(subset=['Price', 'Mileage', 'Year', 'Manufacturer', 'Model'])
df = df[df['Price'] > 100]
df = df[df['Price'] < 12000]
df['YearOnly'] = (df['Year'] // 100).astype(int)

# ëª¨ë¸/ì¸ì½”ë”/í”¼ì²˜ ë¡œë“œ
model = joblib.load('models/domestic_ultimate.pkl')
encoders = joblib.load('models/domestic_ultimate_encoders.pkl')
feature_cols = joblib.load('models/domestic_ultimate_features.pkl')

# Target Encoding ë³€í™˜
model_enc = encoders['Model_target_enc']
if hasattr(model_enc, 'to_dict'):
    model_enc = model_enc.to_dict()
mfr_enc = encoders['Manufacturer_target_enc']
if hasattr(mfr_enc, 'to_dict'):
    mfr_enc = mfr_enc.to_dict()
my_enc = encoders['Model_Year_target_enc']
if hasattr(my_enc, 'to_dict'):
    my_enc = my_enc.to_dict()

# ì£¼ìš” ì¸ê¸° ëª¨ë¸ ëª©ë¡
popular_models = [
    'ì¹´ë‹ˆë°œ 4ì„¸ëŒ€', 'ë” ë‰´ ê·¸ëœì € IG', 'ê·¸ëœì € IG', 'ì˜ë Œí†  4ì„¸ëŒ€', 'íŒ°ë¦¬ì„¸ì´ë“œ',
    'ì˜ë‚˜íƒ€ (DN8)', 'ì•„ë°˜ë–¼ (CN7)', 'K5 3ì„¸ëŒ€', 'ì‹¼íƒ€í˜ (MX5)', 'íˆ¬ì‹¼ (NX4)',
    'ìºìŠ¤í¼', 'ìŠ¤íƒ€ë¦¬ì•„', 'ë” ë‰´ ë ˆì´', 'ì˜¬ ë‰´ ëª¨ë‹', 'ìŠ¤í¬í‹°ì§€ 5ì„¸ëŒ€',
    'ê·¸ëœì € HG', 'ì•„ë°˜ë–¼ AD', 'SM6', 'ì½”ë‚˜ (SX2)', 'ì…€í† ìŠ¤'
]

# ìµœê·¼ ì—°ì‹ (2020-2024)
test_years = [2024, 2023, 2022, 2021, 2020]

results = []

for model_name in popular_models:
    for year in test_years:
        # í•´ë‹¹ ëª¨ë¸+ì—°ì‹ ë°ì´í„° í•„í„°ë§
        subset = df[(df['Model'] == model_name) & (df['YearOnly'] == year)]
        
        if len(subset) < 5:  # ìƒ˜í”Œì´ ì ìœ¼ë©´ ìŠ¤í‚µ
            continue
        
        # ì‹¤ì œ í‰ê·  ê°€ê²©
        actual_price = subset['Price'].mean()
        actual_std = subset['Price'].std()
        
        # ì˜ˆì¸¡ì„ ìœ„í•œ í”¼ì²˜ ìƒì„±
        sample = subset.iloc[0]
        
        age = 2025 - year
        mileage = subset['Mileage'].mean()
        
        # Target Encoding
        model_target = model_enc.get(model_name, 7.5)
        mfr_target = mfr_enc.get(sample['Manufacturer'], 7.5)
        my_key = f"{model_name}_{year}"
        my_target = my_enc.get(my_key, model_target)
        
        # ì˜µì…˜ í‰ê· 
        option_cols_list = ['has_sunroof', 'has_navigation', 'has_leather_seat', 'has_smart_key',
                           'has_rear_camera', 'has_led_lamp', 'has_parking_sensor', 'has_auto_ac',
                           'has_heated_seat', 'has_ventilated_seat']
        option_values = {col: subset[col].mean() if col in subset.columns else 0.5 for col in option_cols_list}
        option_score = sum(option_values.values())
        option_rate = option_score / 10
        
        premium_weights = {'has_sunroof': 1.5, 'has_ventilated_seat': 1.5, 'has_led_lamp': 1.2,
                          'has_leather_seat': 1.3, 'has_navigation': 1.1, 'has_smart_key': 1.0,
                          'has_rear_camera': 1.0, 'has_parking_sensor': 1.0, 'has_auto_ac': 1.0,
                          'has_heated_seat': 1.0}
        option_weighted = sum(option_values.get(col, 0) * w for col, w in premium_weights.items())
        
        # price_segment ì¶”ì • (ì‹¤ì œ í‰ê·  ê°€ê²© ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°) - 15ë¶„ìœ„
        # í…ŒìŠ¤íŠ¸ì—ì„œëŠ” ì‹¤ì œ ê°€ê²©ì„ ì•Œê³  ìˆìœ¼ë¯€ë¡œ, ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ segment ê³„ì‚°
        boundaries = [0, 430, 588, 730, 890, 1090, 1290, 1490, 1690, 1930, 2250, 2630, 3090, 3730, 4750, 999999]
        price_segment = 14
        for i, b in enumerate(boundaries[1:]):
            if actual_price < b:
                price_segment = i
                break
        
        # ì°¨ê¸‰ ë¶„ë¥˜
        model_lower = model_name.lower()
        if any(x in model_lower for x in ['íˆ¬ì‹¼', 'ì½”ë‚˜', 'ì‹¼íƒ€í˜', 'íŒ°ë¦¬ì„¸ì´ë“œ', 'ì˜ë Œí† ', 'ìŠ¤í¬í‹°ì§€', 'ì…€í† ìŠ¤', 'ë‹ˆë¡œ']):
            vehicle_segment = 4
        elif any(x in model_lower for x in ['ì¹´ë‹ˆë°œ', 'ìŠ¤íƒ€ë¦¬ì•„', 'ìŠ¤íƒ€ë ‰ìŠ¤']):
            vehicle_segment = 4
        elif any(x in model_lower for x in ['ê·¸ëœì €', 'k7', 'k8']):
            vehicle_segment = 3
        elif any(x in model_lower for x in ['ì˜ë‚˜íƒ€', 'k5']):
            vehicle_segment = 2
        elif any(x in model_lower for x in ['ì•„ë°˜ë–¼', 'k3']):
            vehicle_segment = 1
        elif any(x in model_lower for x in ['ëª¨ë‹', 'ë ˆì´', 'ìºìŠ¤í¼', 'ìŠ¤íŒŒí¬']):
            vehicle_segment = 0
        else:
            vehicle_segment = 2
        
        # ì—°ë ¹ ê·¸ë£¹
        if age <= 2: age_group = 4
        elif age <= 5: age_group = 3
        elif age <= 8: age_group = 2
        elif age <= 12: age_group = 1
        else: age_group = 0
        
        # í”¼ì²˜ ë°ì´í„°í”„ë ˆì„ ìƒì„±
        feat_data = {
            'Year': year, 'age': age, 'age_squared': age**2, 'age_cubed': age**3,
            'Mileage': mileage, 'mileage_log': np.log1p(mileage), 
            'mileage_squared': mileage**2, 'mileage_per_year': mileage/(age+1),
            'Model_target_enc': model_target, 'Manufacturer_target_enc': mfr_target,
            'Model_Year_target_enc': my_target,
            'FuelType_encoded': 0, 'mileage_condition_encoded': 1,
            'is_eco_fuel': 0, 'vehicle_segment': vehicle_segment, 'price_segment': price_segment,
            'is_accident_free': 1, 'inspection_score': 2, 'is_premium_condition': 0,
            **option_values,
            'option_score': option_score, 'option_rate': option_rate, 'option_weighted': option_weighted,
            'is_metro': 1,
            'age_option_interaction': age * option_rate,
            'age_mileage_interaction': age * np.log1p(mileage),
            'model_option_interaction': model_target * option_weighted,
            'model_age_interaction': model_target * age,
            'model_mileage_interaction': model_target * np.log1p(mileage),
            'brand_age_interaction': mfr_target * age,
            'brand_mileage_interaction': mfr_target * np.log1p(mileage),
            'depreciation_factor': 1 - (age * 0.08 + np.log1p(mileage) * 0.02),
            'estimated_value': model_target * (1 - (age * 0.08 + np.log1p(mileage) * 0.02)),
            'age_group': age_group
        }
        
        X = pd.DataFrame([feat_data])[feature_cols]
        
        # ì˜ˆì¸¡
        pred_log = model.predict(X)[0]
        pred_price = np.expm1(pred_log)
        
        # ì˜¤ì°¨ ê³„ì‚°
        error_pct = abs(pred_price - actual_price) / actual_price * 100
        
        results.append({
            'Model': model_name,
            'Year': year,
            'N': len(subset),
            'Actual': actual_price,
            'Predicted': pred_price,
            'Error%': error_pct
        })

# ê²°ê³¼ ì¶œë ¥
results_df = pd.DataFrame(results)
results_df = results_df.sort_values('Error%')

print("\n" + "="*80)
print("ğŸ“Š ëª¨ë¸ë³„ ì˜ˆì¸¡ ì •í™•ë„ (ì˜¤ì°¨ìœ¨ ë‚®ì€ ìˆœ)")
print("="*80)

for _, row in results_df.iterrows():
    status = "âœ…" if row['Error%'] < 15 else ("âš ï¸" if row['Error%'] < 25 else "âŒ")
    print(f"{status} {row['Model']} {row['Year']}ë…„ (n={row['N']:>3}): "
          f"ì‹¤ì œ {row['Actual']:>6,.0f}ë§Œì› / ì˜ˆì¸¡ {row['Predicted']:>6,.0f}ë§Œì› / ì˜¤ì°¨ {row['Error%']:>5.1f}%")

# ìš”ì•½ í†µê³„
print("\n" + "="*80)
print("ğŸ“ˆ ìš”ì•½ í†µê³„")
print("="*80)
print(f"ì´ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤: {len(results_df)}ê°œ")
print(f"í‰ê·  ì˜¤ì°¨ìœ¨: {results_df['Error%'].mean():.1f}%")
print(f"ì¤‘ì•™ê°’ ì˜¤ì°¨ìœ¨: {results_df['Error%'].median():.1f}%")
print(f"ì˜¤ì°¨ 15% ì´ë‚´: {len(results_df[results_df['Error%'] < 15])}ê°œ ({len(results_df[results_df['Error%'] < 15])/len(results_df)*100:.0f}%)")
print(f"ì˜¤ì°¨ 25% ì´ë‚´: {len(results_df[results_df['Error%'] < 25])}ê°œ ({len(results_df[results_df['Error%'] < 25])/len(results_df)*100:.0f}%)")
