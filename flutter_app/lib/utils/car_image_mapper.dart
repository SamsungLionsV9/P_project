import '../config/environment.dart';

/// 차량 모델 이미지 매핑 유틸리티
/// ML 서버에서 이미지 제공 (APK 크기 최소화 + 실제 차량 이미지 사용)

class CarImageMapper {
  // ML 서버 이미지 베이스 URL (환경 설정에서 가져옴)
  static String get _baseUrl => Environment.imageServiceUrl;

  // 모델명 → 이미지 파일명 매핑 (국산차 + 외제차)
  static const Map<String, String> _modelToImage = {
    // ========== 국산차 ==========
    // 기아
    'K3': 'K3', 'K5': 'K5', 'K7': 'K7', 'K8': 'K8', 'K9': 'K9',
    'EV3': 'EV3', 'EV4': 'EV4', 'EV5': 'EV5', 'EV6': 'EV6', 'EV9': 'EV9', 'PV5': 'PV5',
    '모닝': '모닝', '레이': '레이', '니로': '니로', '셀토스': '셀토스',
    '쏘렌토': '쏘렌토', '스토닉': '스토닉', '쏘울': '쏘울', '스팅어': '스팅어',
    '포르테': '포르테', '카렌스': '카렌스', '프라이드': '프라이드',
    '스펙트라': '스펙트라', '엔터프라이즈': '엔터프라이즈', '타스만': '타스만',
    '카스타': '카스타', '엘란': '엘란', '비스토': '비스토', '캐피탈': '캐피탈',
    '카니발': '그랜드 카니발', '카니발 4세대': '그랜드 카니발',
    '그랜드 카니발': '그랜드 카니발', '카니발 II': '카니발 II',
    // 현대
    '그랜저': '그랜저', '쏘나타': '쏘나타', '아반떼': '아반떼',
    '더 뉴 아반떼': '아반떼', '더 뉴 그랜저': '그랜저', '더 뉴 쏘나타': '쏘나타',
    '투싼': '투싼', '싼타페': '싼타페', '스타리아': '스타리아', '스타렉스': '스타렉스',
    '아이오닉': '아이오닉', '베리타스': '베리타스', '슈퍼살롱': '슈퍼살롱',
    '뉴 다마스': '뉴 다마스', '다마스 II': '다마스 II', '라보': '라보', '포텐샤': '포텐샤',
    '에스페로': '에스페로', '스테이츠맨': '스테이츠맨',
    // 제네시스
    'G70': 'G70', 'G80': 'G80', 'G90': 'G90', 'G2X': 'G2X',
    'GV60': 'GV60', 'GV70': 'GV70', 'GV80': 'GV80',
    // 르노코리아
    'SM3': 'SM3', 'SM5': 'SM5', 'SM6': 'SM6', 'SM7': 'SM7',
    'QM3': 'QM3', 'QM5': 'QM5', 'QM6': 'QM6', 'XM3': 'XM3',
    '클리오': '클리오', '조에': '조에', '캡처': '캡처', '마스터': '마스터',
    '그랑 콜레오스': '그랑 콜레오스', '아르카나': '아르카나',
    // 쉐보레/GM
    '스파크': '스파크', '크루즈': '크루즈', '말리부': '말리부',
    '임팔라': '임팔라', '트랙스': '트랙스', '이쿼녹스': '이쿼녹스',
    '트래버스': '트래버스', '볼트': '볼트', '캡티바': '캡티바',
    '울란도': '울란도', '토스카': '토스카', '콜로라도': '콜로라도',
    '타호': '타호', '아카디아': '아카디아', '카마로': '카마로',
    '라세티 프리미어': '라세티 프리미어', '젠트라': '젠트라', '알페온': '알페온',
    '마티즈 클래식': '마티즈 클래식', '아베오 세단': '아베오 세단',
    '아베오 해치백': '아베오 해치백', '윈스톰': '윈스톰', '크레도스': '크레도스', '리갈': '리갈',
    // 쌍용/KG
    '티볼리': '티볼리', '토레스': '토레스', '모하비': '모하비', '액티언': '액티언',
    '더 뉴 티볼리': '더 뉴 티볼리', '더 뉴 토레스': '더 뉴 토레스',
    '티볼리 에어': '티볼리 에어', '코란도 C': '코란도 C',
    '코란도': '뷰티풀 코란도', '렉스턴': '렉스턴 II',
    '더 뉴 렉스턴 스포츠': '더 뉴 렉스턴 스포츠', '렉스턴 스포츠 칸': '렉스턴 스포츠 칸',
    '렉스턴 II': '렉스턴 II', '더 뉴 코란도 스포츠': '더 뉴 코란도 스포츠',
    '뷰티풀 코란도': '뷰티풀 코란도', '뉴무쏘': '뉴무쏘', '뉴체어맨': '뉴체어맨',
    '로디우스 유로': '로디우스 유로', '이스타나': '이스타나',
    '로체': '로체', '티코': '티코', '프레지오': '프레지오',
    
    // ========== 외제차 ==========
    // BMW (브랜드+모델 조합 포함)
    'BMW 3시리즈': 'BMW 3시리즈', 'BMW 5시리즈': 'BMW 5시리즈', 'BMW 7시리즈': 'BMW 7시리즈',
    '3시리즈': 'BMW 3시리즈', '5시리즈': 'BMW 5시리즈', '7시리즈': 'BMW 7시리즈',
    'BMW X3': 'X3', 'BMW X5': 'X5', 'BMW X6': 'X6', 'BMW X7': 'X7',
    'X3': 'X3', 'X5': 'X5', 'X6': 'X6', 'X7': 'X7',
    'BMW i3': 'i3', 'BMW i4': 'i4', 'BMW i5': 'i5', 'BMW i7': 'i7',
    'i3': 'i3', 'i4': 'i4', 'i5': 'i5', 'i7': 'i7',
    'BMW iX1': 'iX1', 'BMW iX3': 'iX3', 'iX1': 'iX1', 'iX3': 'iX3',
    // 메르세데스-벤츠
    'A-클래스': 'A-클래스', 'C-클래스': 'C-클래스', 'E-클래스': 'E-클래스', 'S-클래스': 'S-클래스',
    'GLC': 'GLC', 'GLE': 'GLE', 'GLS': 'GLS', 'AMG GT': 'AMG GT',
    // 아우디
    'A4': 'A4', 'A6': 'A6', 'A7': 'A7', 'A8': 'A8',
    'Q5': 'Q5', 'Q7': 'Q7', 'Q8': 'Q8', 'E-트론': 'E-트론',
    // 렉서스
    'ES': 'ES', 'RX': 'RX', 'NX': 'NX', 'UX': 'UX', 'LM': 'LM',
    // 볼보
    'S90': 'S90', 'V60': 'V60', 'XC40': 'XC40', 'XC60': 'XC60', 'XC90': 'XC90',
    // 포르쉐
    '911': '911', '카이엔': '카이엔', '마칸': '마칸', '파나메라': '파나메라',
    '타이칸': '타이칸', '박스터': '박스터', '카이맨': '카이맨',
    // 재규어
    'XE': 'XE', 'XF': 'XF', 'XJ': 'XJ', 'F-PACE': 'F-PACE', 'F-TYPE': 'F-TYPE',
    // 랜드로버
    '레인지로버': '레인지로버', '디스커버리': '디스커버리', '디펜더': '디펜더',
    '벨라': '벨라', '이보크': '이보크',
    // 폭스바겐
    '골프': '골프', '티구안': '티구안', '파사트': '파사트', '아테온': '아테온', '제타': '제타',
    'ID': 'ID',
    // 토요타
    '캠리': '캠리', 'RAV4': 'RAV4', '프리우스': '프리우스', '시에나': '시에나', '알파드': '알파드',
    // 혼다
    '어코드': '어코드', '시빅': '시빅', 'CR-V': 'CR-V', '오딧세이': '오딧세이', '파일럿': '파일럿',
    // 닛산
    '맥시마': '맥시마', '알티마': '알티마', '무라노': '무라노', '패스파인더': '패스파인더',
    // 인피니티
    'Q50': 'Q50', 'Q30': 'Q30', 'QX60': 'QX60',
    // 테슬라 (다양한 검색 패턴 지원)
    '테슬라 모델3': '테슬라 모델3', '테슬라 모델S': '테슬라 모델S', '테슬라 모델X': '테슬라 모델X', '테슬라 모델Y': '테슬라 모델Y',
    '테슬라 모델 3': '테슬라 모델3', '테슬라 모델 S': '테슬라 모델S', '테슬라 모델 X': '테슬라 모델X', '테슬라 모델 Y': '테슬라 모델Y',
    '테슬라 Model 3': '테슬라 모델3', '테슬라 Model S': '테슬라 모델S', '테슬라 Model X': '테슬라 모델X', '테슬라 Model Y': '테슬라 모델Y',
    'Tesla Model 3': '테슬라 모델3', 'Tesla Model S': '테슬라 모델S', 'Tesla Model X': '테슬라 모델X', 'Tesla Model Y': '테슬라 모델Y',
    '모델3': '테슬라 모델3', '모델S': '테슬라 모델S', '모델X': '테슬라 모델X', '모델Y': '테슬라 모델Y',
    '모델 3': '테슬라 모델3', '모델 S': '테슬라 모델S', '모델 X': '테슬라 모델X', '모델 Y': '테슬라 모델Y',
    'Model 3': '테슬라 모델3', 'Model S': '테슬라 모델S', 'Model X': '테슬라 모델X', 'Model Y': '테슬라 모델Y',
    'Model3': '테슬라 모델3', 'ModelS': '테슬라 모델S', 'ModelX': '테슬라 모델X', 'ModelY': '테슬라 모델Y',
    // 미니
    '미니쿠퍼': '미니쿠퍼', '쿠퍼': '미니쿠퍼', 'MINI 쿠퍼': '미니쿠퍼', '미니 쿠퍼': '미니쿠퍼',
    // 페라리 (브랜드+모델 조합)
    '페라리 296': '페라리 296', '페라리 488': '페라리 488', '페라리 F8': '페라리 F8', 
    '페라리 SF90': '페라리 SF90', '페라리 로마': '페라리 로마',
    '296': '페라리 296', '488': '페라리 488', 'F8': '페라리 F8', 'SF90': '페라리 SF90', '로마': '페라리 로마',
    'Ferrari 296': '페라리 296', 'Ferrari 488': '페라리 488', 'Ferrari F8': '페라리 F8',
    // 람보르기니 (브랜드+모델 조합)
    '람보르기니 아벤타도르': '람보르기니 아벤타도르', '람보르기니 우라칸': '람보르기니 우라칸', '람보르기니 우루스': '람보르기니 우루스',
    '아벤타도르': '람보르기니 아벤타도르', '우라칸': '람보르기니 우라칸', '우루스': '람보르기니 우루스',
    'Lamborghini Aventador': '람보르기니 아벤타도르', 'Lamborghini Urus': '람보르기니 우루스',
    // 벤틀리 (브랜드+모델 조합)
    '벤틀리 벤테이가': '벤틀리 벤테이가', '벤틀리 컨티넨탈 GT': '벤틀리 컨티넨탈 GT', '벤틀리 플라잉스퍼': '벤틀리 플라잉스퍼',
    '벤테이가': '벤틀리 벤테이가', '컨티넨탈 GT': '벤틀리 컨티넨탈 GT', '플라잉스퍼': '벤틀리 플라잉스퍼',
    // 롤스로이스 (브랜드+모델 조합)
    '롤스로이스 고스트': '롤스로이스 고스트', '롤스로이스 컬리넌': '롤스로이스 컬리넌', '롤스로이스 팬텀': '롤스로이스 팬텀',
    '고스트': '롤스로이스 고스트', '컬리넌': '롤스로이스 컬리넌', '팬텀': '롤스로이스 팬텀',
    // 마세라티 (브랜드+모델 조합)
    '마세라티 기블리': '마세라티 기블리', '마세라티 르반떼': '마세라티 르반떼', '마세라티 콰트로포르테': '마세라티 콰트로포르테',
    '기블리': '마세라티 기블리', '르반떼': '마세라티 르반떼', '콰트로포르테': '마세라티 콰트로포르테',
    // 지프 (브랜드+모델 조합)
    '지프 그랜드 체로키': '지프 그랜드 체로키', '지프 랭글러': '지프 랭글러', '지프 레니게이드': '지프 레니게이드', '지프 체로키': '지프 체로키',
    '그랜드 체로키': '지프 그랜드 체로키', '랭글러': '지프 랭글러', '레니게이드': '지프 레니게이드', '체로키': '지프 체로키',
    'Jeep Wrangler': '지프 랭글러', 'Jeep Cherokee': '지프 체로키',
    // 포드 (브랜드+모델 조합)
    '포드 F150': '포드 F150', '포드 머스탱': '포드 머스탱', '포드 브롱코': '포드 브롱코', '포드 익스플로러': '포드 익스플로러',
    'F150': '포드 F150', '머스탱': '포드 머스탱', '브롱코': '포드 브롱코', '익스플로러': '포드 익스플로러',
    'Ford Mustang': '포드 머스탱', 'Ford Explorer': '포드 익스플로러', 'Ford F-150': '포드 F150',
    // 링컨 (브랜드+모델 조합)
    '링컨 네비게이터': '링컨 네비게이터', '링컨 노틸러스': '링컨 노틸러스', '링컨 에비에이터': '링컨 에비에이터',
    '네비게이터': '링컨 네비게이터', '노틸러스': '링컨 노틸러스', '에비에이터': '링컨 에비에이터',
    // 캐딜락 (브랜드+모델 조합)
    '캐딜락 CT6': '캐딜락 CT6', '캐딜락 XT5': '캐딜락 XT5', '캐딜락 에스컬레이드': '캐딜락 에스컬레이드',
    'CT6': '캐딜락 CT6', 'XT5': '캐딜락 XT5', '에스컬레이드': '캐딜락 에스컬레이드',
    // 폴스타
    '폴스타 2': '폴스타2', '폴스타 4': '폴스타4', '폴스타2': '폴스타2', '폴스타4': '폴스타4',
    'Polestar 2': '폴스타2', 'Polestar 4': '폴스타4',
    // 푸조 (브랜드+모델 조합)
    '푸조 208': '푸조 208', '푸조 3008': '푸조 3008', '푸조 5008': '푸조 5008', '푸조 508': '푸조 508',
    '208': '푸조 208', '3008': '푸조 3008', '5008': '푸조 5008', '508': '푸조 508',
    // 피아트 (브랜드+모델 조합)
    '피아트 500': '피아트 500', '500': '피아트 500', 'Fiat 500': '피아트 500',
  };

  // 부분 매칭 키워드 (우선순위 순 - 긴 키워드 우선)
  static const List<String> _partialMatchKeys = [
    // ========== 국산차 ==========
    // 현대
    '그랜저', '쏘나타', '아반떼', '투싼', '싼타페', '팰리세이드', '스타리아', '스타렉스', '코나',
    '아이오닉', '캐스퍼', '베뉴', '베리타스', '슈퍼살롱', '다마스', '라보', '포텐샤',
    // 기아
    '쏘렌토', '카니발', '모닝', '레이', '니로', '셀토스', '스팅어', '스포티지',
    '스토닉', '쏘울', '포르테', '카렌스', '프라이드', '타스만', '엔터프라이즈',
    'K3', 'K5', 'K7', 'K8', 'K9', 'EV3', 'EV4', 'EV5', 'EV6', 'EV9', 'PV5',
    // 제네시스
    'G70', 'G80', 'G90', 'G2X', 'GV60', 'GV70', 'GV80',
    // 르노
    'SM3', 'SM5', 'SM6', 'SM7', 'QM3', 'QM5', 'QM6', 'XM3',
    '클리오', '조에', '캡처', '마스터', '아르카나', '콜레오스',
    // 쉐보레
    '스파크', '크루즈', '말리부', '임팔라', '트랙스', '이쿼녹스',
    '트래버스', '볼트', '캡티바', '올란도', '토스카', '콜로라도', '타호',
    '라세티', '젠트라', '알페온', '마티즈', '아베오', '윈스톰', '카마로',
    // 쌍용/KG
    '티볼리', '토레스', '코란도', '렉스턴', '모하비', '액티언',
    '무쏘', '체어맨', '로디우스', '이스타나',
    '로체', '티코', '프레지오',
    
    // ========== 외제차 ==========
    // BMW
    '3시리즈', '5시리즈', '7시리즈', 'X3', 'X5', 'X6', 'X7', 'i3', 'i4', 'i5', 'i7', 'iX1', 'iX3',
    // 벤츠
    'A-클래스', 'C-클래스', 'E-클래스', 'S-클래스', 'GLC', 'GLE', 'GLS', 'AMG GT',
    // 아우디
    'A4', 'A6', 'A7', 'A8', 'Q5', 'Q7', 'Q8', 'E-트론',
    // 렉서스
    'ES', 'RX', 'NX', 'UX', 'LM',
    // 볼보
    'S90', 'V60', 'XC40', 'XC60', 'XC90',
    // 포르쉐
    '911', '카이엔', '마칸', '파나메라', '타이칸', '박스터', '카이맨',
    // 재규어/랜드로버
    'XE', 'XF', 'XJ', 'F-PACE', 'F-TYPE', '레인지로버', '디스커버리', '디펜더', '벨라', '이보크',
    // 폭스바겐
    '골프', '티구안', '파사트', '아테온', '제타', 'ID',
    // 일본차
    '캠리', 'RAV4', '프리우스', '시에나', '알파드', '어코드', '시빅', 'CR-V', '오딧세이', '파일럿',
    '맥시마', '알티마', '무라노', '패스파인더', 'Q50', 'Q30', 'QX60',
    // 테슬라 (브랜드 + 모델명 우선)
    '테슬라 모델3', '테슬라 모델S', '테슬라 모델X', '테슬라 모델Y',
    '테슬라', 'Tesla', '모델3', '모델S', '모델X', '모델Y', 'Model 3', 'Model S', 'Model X', 'Model Y',
    // 슈퍼카/럭셔리
    '아벤타도르', '우라칸', '우루스', '벤테이가', '컨티넨탈', '플라잉스퍼',
    '고스트', '컬리넌', '팬텀', '기블리', '르반떼', '콰트로포르테',
    // 미국차
    '그랜드 체로키', '랭글러', '레니게이드', '체로키', 'F150', '머스탱', '브롱코', '익스플로러',
    '네비게이터', '노틸러스', '에비에이터', 'CT6', 'XT5', '에스컬레이드',
    // 기타
    '미니쿠퍼', '쿠퍼', '폴스타2', '폴스타4', '208', '3008', '5008', '508', '500',
  ];

  /// 모델명으로 이미지 URL 반환 (서버에서 제공)
  static String? getImageUrl(String model) {
    // 괄호 제거 및 정규화 (예: "그랜저 (GN7)" → "그랜저")
    final cleanModel = model.replaceAll(RegExp(r'\s*\([^)]*\)'), '').trim();
    
    String? resultUrl;
    String matchType = '';
    
    // 1. 정규화된 모델명으로 정확한 매칭
    if (_modelToImage.containsKey(cleanModel)) {
      resultUrl = '$_baseUrl/${Uri.encodeComponent(_modelToImage[cleanModel]!)}.png';
      matchType = 'exact-clean';
    }
    // 2. 원본으로 정확한 매칭
    else if (_modelToImage.containsKey(model)) {
      resultUrl = '$_baseUrl/${Uri.encodeComponent(_modelToImage[model]!)}.png';
      matchType = 'exact-original';
    }
    else {
      // 3. 부분 매칭 (정규화된 모델명으로)
      for (final key in _partialMatchKeys) {
        if (cleanModel.contains(key) || model.contains(key)) {
          if (_modelToImage.containsKey(key)) {
            resultUrl = '$_baseUrl/${Uri.encodeComponent(_modelToImage[key]!)}.png';
            matchType = 'partial:$key';
            break;
          }
        }
      }
    }

    // 4. 매칭 실패시 null 반환 (존재하지 않는 파일 요청 방지)
    // 이렇게 하면 Flutter에서 placeholder 아이콘을 표시함
    if (resultUrl == null) {
      matchType = 'no-match';
      if (Environment.isDebug) {
        print('[CarImageMapper] model="$model" → clean="$cleanModel" → NO IMAGE FOUND');
      }
      return null;
    }
    
    // 디버그 로그 (개발 환경에서만)
    if (Environment.isDebug) {
      print('[CarImageMapper] model="$model" → clean="$cleanModel" → match=$matchType → $resultUrl');
    }
    
    return resultUrl;
  }

  /// 브랜드와 모델명으로 이미지 URL 반환 (브랜드+모델 조합 시도)
  static String? getImageUrlByBrandModel(String brand, String model) {
    // 1. 브랜드+모델 조합으로 먼저 시도 (테슬라 모델3 등)
    final combined = '$brand $model'.trim();
    final result = getImageUrl(combined);
    if (result != null) return result;
    
    // 2. 모델명만으로 시도
    return getImageUrl(model);
  }

  /// 이미지 URL이 있는지 확인
  static bool hasImage(String model) {
    return _modelToImage.containsKey(model) ||
           _partialMatchKeys.any((key) => model.contains(key));
  }
}

